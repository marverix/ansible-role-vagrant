---
- name: Check if Vagrant is already installed
  command: "vagrant --version"
  register: test
  ignore_errors: yes
  failed_when: no
  changed_when: yes

- name: Installation block
  when: test.msg is defined or
    not (test.stdout | regex_search('^Vagrant ' + vagrant_version | string))
  block:
  
    - name: Set package name
      set_fact:
        vagrant_package_name: "vagrant_{{ vagrant_version }}_x86_64.{{ vagrant_package_ext[ansible_distribution] }}"

    - name: Set package path
      set_fact:
        vagrant_package_path: "/tmp/{{ vagrant_package_name }}"

    - name: Download the file
      get_url:
        url: "https://releases.hashicorp.com/vagrant/{{ vagrant_version }}/{{ vagrant_package_name }}"
        dest: "{{ vagrant_package_path }}"
        checksum: "sha256:{{ vagrant_package_checksum[vagrant_package_ext[ansible_distribution]] }}"

    - name: Install package (Ubuntu)
      when: ansible_distribution == 'Ubuntu'
      apt:
        deb: "{{ vagrant_package_path }}"

    - name: Install package (CentOS)
      when: ansible_distribution == 'CentOS'
      yum:
        name: "{{ vagrant_package_path }}"

    - name: Cleaning
      file:
        path: "{{ vagrant_package_path }}"
        state: absent
